<html>

<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
  <script>
    function deriveKey(passphrase, salt) {
      return CryptoJS.PBKDF2(passphrase, salt, {
        keySize: 256 / 32,
        iterations: 100000,
        hasher: CryptoJS.algo.SHA256 // Recommended: Explicitly use SHA256
      });
    }

    function uint8ToBase64(uint8) {
      let binary = "";
      const chunkSize = 0x8000; // ÈÅøÂÖç call stack overflow

      for (let i = 0; i < uint8.length; i += chunkSize) {
        const chunk = uint8.subarray(i, i + chunkSize);
        binary += String.fromCharCode(...chunk);
      }

      return btoa(binary);
    }

    function base64ToUint8(base64) {
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);

      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }

      return bytes;
    }

    async function compress(str) {
      const encoder = new TextEncoder();
      const data = encoder.encode(str);

      const cs = new CompressionStream("gzip");
      const writer = cs.writable.getWriter();
      writer.write(data);
      writer.close();

      const buffer = await new Response(cs.readable).arrayBuffer();
      return uint8ToBase64(new Uint8Array(buffer));
    }

    async function encrypt() {
      const passphrase = document.getElementById('kkey').value
      const value = await compress(document.getElementById('text').value.trim())

      const salt = CryptoJS.lib.WordArray.random(32)
      const key = deriveKey(passphrase, salt)
      const iv = CryptoJS.lib.WordArray.random(16)

      const cipher = CryptoJS.AES.encrypt(value, key, { iv: iv }).toString()
      const result =
        salt.toString(CryptoJS.enc.Base64) +
        ':' +
        iv.toString(CryptoJS.enc.Base64) +
        ':' +
        cipher

      document.getElementById('text').value = result
    }

    async function decompress(base64) {
      const uint8 = base64ToUint8(base64);

      const ds = new DecompressionStream("gzip");
      const writer = ds.writable.getWriter();
      writer.write(uint8);
      writer.close();

      const buffer = await new Response(ds.readable).arrayBuffer();
      return new TextDecoder().decode(buffer);
    }

    async function decrypt() {
      try {
        document.getElementById('kkey').disabled = true
        await new Promise((r) => setTimeout(r))
        const passphrase = document.getElementById('kkey').value
        const value = document.getElementById('text').value.trim()
        const parts = value.split(':')
        if (parts.length < 3) throw new Error('Invalid ciphertext')
        const salt = CryptoJS.enc.Base64.parse(parts[0])
        const iv = CryptoJS.enc.Base64.parse(parts[1])
        const ciphertext = parts.slice(2).join(':')

        let decipher = CryptoJS.AES.decrypt(ciphertext, deriveKey(passphrase, salt), { iv: iv })
        decipher = decipher.toString(CryptoJS.enc.Utf8)
        if (!decipher) {
          throw new Error('Decryption failed')
        }
        decipher = await decompress(decipher)
        document.getElementById('text').value = decipher
      } catch (err) {
        document.getElementById('kkey').style.color = 'red'
        throw err
      } finally {
        document.getElementById('kkey').disabled = false
      }
      document.getElementById('kkey').style.color = 'black'
    }

    function generatePassword() {
      const length = 12
      const lowercase = 'abcdefghijklmnopqrstuvwxyz'
      const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'
      const digits = '0123456789'
      const allChars = lowercase + uppercase + digits

      let retVal = ''
      retVal += lowercase.charAt(Math.floor(Math.random() * lowercase.length))
      retVal += uppercase.charAt(Math.floor(Math.random() * uppercase.length))
      retVal += digits.charAt(Math.floor(Math.random() * digits.length))

      for (let i = 4, n = allChars.length; i < length; ++i) {
        retVal += allChars.charAt(Math.floor(Math.random() * n))
      }

      retVal = retVal.split('').sort(() => Math.random() - 0.5).join('') // Shuffle the password
      document.getElementById('genPw').innerText = retVal
    }

    const pageLoadTime = Date.now()
    setInterval(() => {
      if (Date.now() > pageLoadTime + 3600000) {
        location.reload()
      }
    }, 60000)
  </script>
  <style>
    * {
      font-size: 16px !important;
    }
  </style>
</head>

<body>
  <input id="kkey" type="password" style="margin-top: 5px;" onKeydown="javascript: if (event.keyCode===13) decrypt()" />
  <button onclick="decrypt()">üîë</button>
  <button onclick="encrypt()">üîí</button>
  <div>
    <textarea id="text" style="width: 100%; height: 90vh; margin-top: 5px;">
      HIc3b9LlqU04SOPEFQJYinLJJ8XYi7bQX4lfMK+7sJM=:dFjJeM0Mz4HCmquiVgWrhA==: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
    </textarea>
  </div>

  <script>
    document.getElementById('kkey').focus()
  </script>
</body>

</html>
