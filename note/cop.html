<html>

<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
  <script>
    function deriveKey(passphrase, salt) {
      return CryptoJS.PBKDF2(passphrase, salt, {
        keySize: 256 / 32,
        iterations: 100000,
        hasher: CryptoJS.algo.SHA256 // Recommended: Explicitly use SHA256
      });
    }

    function uint8ToBase64(uint8) {
      let binary = "";
      const chunkSize = 0x8000; // ÈÅøÂÖç call stack overflow

      for (let i = 0; i < uint8.length; i += chunkSize) {
        const chunk = uint8.subarray(i, i + chunkSize);
        binary += String.fromCharCode(...chunk);
      }

      return btoa(binary);
    }

    function base64ToUint8(base64) {
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);

      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }

      return bytes;
    }

    async function compress(str) {
      const encoder = new TextEncoder();
      const data = encoder.encode(str);

      const cs = new CompressionStream("gzip");
      const writer = cs.writable.getWriter();
      writer.write(data);
      writer.close();

      const buffer = await new Response(cs.readable).arrayBuffer();
      return uint8ToBase64(new Uint8Array(buffer));
    }

    async function encrypt() {
      const passphrase = document.getElementById('kkey').value
      const value = await compress(document.getElementById('text').value.trim())

      const salt = CryptoJS.lib.WordArray.random(32)
      const key = deriveKey(passphrase, salt)
      const iv = CryptoJS.lib.WordArray.random(16)

      const cipher = CryptoJS.AES.encrypt(value, key, { iv: iv }).toString()
      const result =
        salt.toString(CryptoJS.enc.Base64) +
        ':' +
        iv.toString(CryptoJS.enc.Base64) +
        ':' +
        cipher

      document.getElementById('text').value = result
    }

    async function decompress(base64) {
      const uint8 = base64ToUint8(base64);

      const ds = new DecompressionStream("gzip");
      const writer = ds.writable.getWriter();
      writer.write(uint8);
      writer.close();

      const buffer = await new Response(ds.readable).arrayBuffer();
      return new TextDecoder().decode(buffer);
    }

    async function decrypt() {
      try {
        document.getElementById('kkey').disabled = true
        await new Promise((r) => setTimeout(r))
        const passphrase = document.getElementById('kkey').value
        const value = document.getElementById('text').value.trim()
        const parts = value.split(':')
        if (parts.length < 3) throw new Error('Invalid ciphertext')
        const salt = CryptoJS.enc.Base64.parse(parts[0])
        const iv = CryptoJS.enc.Base64.parse(parts[1])
        const ciphertext = parts.slice(2).join(':')

        let decipher = CryptoJS.AES.decrypt(ciphertext, deriveKey(passphrase, salt), { iv: iv })
        decipher = decipher.toString(CryptoJS.enc.Utf8)
        if (!decipher) {
          throw new Error('Decryption failed')
        }
        decipher = await decompress(decipher)
        document.getElementById('text').value = decipher
      } catch (err) {
        document.getElementById('kkey').style.color = 'red'
        throw err
      } finally {
        document.getElementById('kkey').disabled = false
      }
      document.getElementById('kkey').style.color = 'black'
    }

    function generatePassword() {
      const length = 12
      const lowercase = 'abcdefghijklmnopqrstuvwxyz'
      const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'
      const digits = '0123456789'
      const allChars = lowercase + uppercase + digits

      let retVal = ''
      retVal += lowercase.charAt(Math.floor(Math.random() * lowercase.length))
      retVal += uppercase.charAt(Math.floor(Math.random() * uppercase.length))
      retVal += digits.charAt(Math.floor(Math.random() * digits.length))

      for (let i = 4, n = allChars.length; i < length; ++i) {
        retVal += allChars.charAt(Math.floor(Math.random() * n))
      }

      retVal = retVal.split('').sort(() => Math.random() - 0.5).join('') // Shuffle the password
      document.getElementById('genPw').innerText = retVal
    }

    const pageLoadTime = Date.now()
    setInterval(() => {
      if (Date.now() > pageLoadTime + 3600000) {
        location.reload()
      }
    }, 60000)
  </script>
  <style>
    * {
      font-size: 16px !important;
    }
  </style>
</head>

<body>
  <input id="kkey" type="password" style="margin-top: 5px;" onKeydown="javascript: if (event.keyCode===13) decrypt()" />
  <button onclick="decrypt()">üîë</button>
  <button onclick="encrypt()">üîí</button>
  <div>
    <textarea id="text" style="width: 100%; height: 90vh; margin-top: 5px;">
      /z3fcSUPl+lY4NzFSKP4eVLfqeiZL80bAMUS9JdBO6w=:ABycViSbvljiNfYiBE46hg==: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
    </textarea>
  </div>

  <script>
    document.getElementById('kkey').focus()
  </script>
</body>

</html>
