<html>

<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
  <script>
    function deriveKey(passphrase, salt) {
      return CryptoJS.PBKDF2(passphrase, salt, {
        keySize: 256 / 32,
        iterations: 100000,
        hasher: CryptoJS.algo.SHA256 // Recommended: Explicitly use SHA256
      });
    }

    function uint8ToBase64(uint8) {
      let binary = "";
      const chunkSize = 0x8000; // ÈÅøÂÖç call stack overflow

      for (let i = 0; i < uint8.length; i += chunkSize) {
        const chunk = uint8.subarray(i, i + chunkSize);
        binary += String.fromCharCode(...chunk);
      }

      return btoa(binary);
    }

    function base64ToUint8(base64) {
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);

      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }

      return bytes;
    }

    async function compress(str) {
      const encoder = new TextEncoder();
      const data = encoder.encode(str);

      const cs = new CompressionStream("gzip");
      const writer = cs.writable.getWriter();
      writer.write(data);
      writer.close();

      const buffer = await new Response(cs.readable).arrayBuffer();
      return uint8ToBase64(new Uint8Array(buffer));
    }

    async function encrypt() {
      const passphrase = document.getElementById('kkey').value
      const value = await compress(document.getElementById('text').value.trim())

      const salt = CryptoJS.lib.WordArray.random(32)
      const key = deriveKey(passphrase, salt)
      const iv = CryptoJS.lib.WordArray.random(16)

      const cipher = CryptoJS.AES.encrypt(value, key, { iv: iv }).toString()
      const result =
        salt.toString(CryptoJS.enc.Base64) +
        ':' +
        iv.toString(CryptoJS.enc.Base64) +
        ':' +
        cipher

      document.getElementById('text').value = result
    }

    async function decompress(base64) {
      const uint8 = base64ToUint8(base64);

      const ds = new DecompressionStream("gzip");
      const writer = ds.writable.getWriter();
      writer.write(uint8);
      writer.close();

      const buffer = await new Response(ds.readable).arrayBuffer();
      return new TextDecoder().decode(buffer);
    }

    async function decrypt() {
      try {
        document.getElementById('kkey').disabled = true
        await new Promise((r) => setTimeout(r))
        const passphrase = document.getElementById('kkey').value
        const value = document.getElementById('text').value.trim()
        const parts = value.split(':')
        if (parts.length < 3) throw new Error('Invalid ciphertext')
        const salt = CryptoJS.enc.Base64.parse(parts[0])
        const iv = CryptoJS.enc.Base64.parse(parts[1])
        const ciphertext = parts.slice(2).join(':')

        let decipher = CryptoJS.AES.decrypt(ciphertext, deriveKey(passphrase, salt), { iv: iv })
        decipher = decipher.toString(CryptoJS.enc.Utf8)
        if (!decipher) {
          throw new Error('Decryption failed')
        }
        decipher = await decompress(decipher)
        document.getElementById('text').value = decipher
      } catch (err) {
        document.getElementById('kkey').style.color = 'red'
        throw err
      } finally {
        document.getElementById('kkey').disabled = false
      }
      document.getElementById('kkey').style.color = 'black'
    }

    function generatePassword() {
      const length = 12
      const lowercase = 'abcdefghijklmnopqrstuvwxyz'
      const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'
      const digits = '0123456789'
      const allChars = lowercase + uppercase + digits

      let retVal = ''
      retVal += lowercase.charAt(Math.floor(Math.random() * lowercase.length))
      retVal += uppercase.charAt(Math.floor(Math.random() * uppercase.length))
      retVal += digits.charAt(Math.floor(Math.random() * digits.length))

      for (let i = 4, n = allChars.length; i < length; ++i) {
        retVal += allChars.charAt(Math.floor(Math.random() * n))
      }

      retVal = retVal.split('').sort(() => Math.random() - 0.5).join('') // Shuffle the password
      document.getElementById('genPw').innerText = retVal
    }

    const pageLoadTime = Date.now()
    setInterval(() => {
      if (Date.now() > pageLoadTime + 3600000) {
        location.reload()
      }
    }, 60000)
  </script>
  <style>
    * {
      font-size: 16px !important;
    }
  </style>
</head>

<body>
  <input id="kkey" type="password" style="margin-top: 5px;" onKeydown="javascript: if (event.keyCode===13) decrypt()" />
  <button onclick="decrypt()">üîë</button>
  <button onclick="encrypt()">üîí</button>
  <div>
    <textarea id="text" style="width: 100%; height: 90vh; margin-top: 5px;">
      eXcI5XFijr6cYQvIgChzlLAlZrEDIG0UZBHGXn0+gIg=:CVMH8mnQvxhzCZsfMqi/WQ==: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
    </textarea>
  </div>

  <script>
    document.getElementById('kkey').focus()
  </script>
</body>

</html>
